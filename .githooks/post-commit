#!/bin/bash
# Automatically update CHANGELOG.md after each commit
# Extracts commit type and description from conventional commit format

# Get the latest commit message
COMMIT_MSG=$(git log -1 --pretty=%B)
COMMIT_HASH=$(git log -1 --pretty=%h)
COMMIT_DATE=$(git log -1 --pretty=%ad --date=short)

# Parse conventional commit format: type(scope): description
if [[ $COMMIT_MSG =~ ^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\([a-zA-Z0-9_-]+\))?:\ (.+)$ ]]; then
    TYPE="${BASH_REMATCH[1]}"
    SCOPE="${BASH_REMATCH[2]}"
    DESC="${BASH_REMATCH[3]}"

    # Map commit type to changelog category
    case "$TYPE" in
        feat)
            CATEGORY="Added"
            ;;
        fix)
            CATEGORY="Fixed"
            ;;
        docs)
            CATEGORY="Documentation"
            ;;
        refactor|perf)
            CATEGORY="Changed"
            ;;
        test)
            CATEGORY="Testing"
            ;;
        ci|build)
            CATEGORY="Build"
            ;;
        *)
            CATEGORY="Changed"
            ;;
    esac

    # Check if CHANGELOG.md exists
    if [ -f "CHANGELOG.md" ]; then
        # Use awk to insert into correct category
        awk -v cat="$CATEGORY" -v desc="- $DESC" '
            /## \[Unreleased\]/ { print; unreleased=1; next }
            unreleased && /### / {
                if ($0 ~ "### " cat) {
                    print
                    print desc
                    inserted=1
                    next
                }
            }
            unreleased && /## \[/ && !inserted {
                # Reached next version, need to add category
                print ""
                print "### " cat
                print desc
                print ""
                inserted=1
            }
            { print }
        ' CHANGELOG.md > CHANGELOG.md.tmp

        # Only update if file changed
        if ! cmp -s CHANGELOG.md CHANGELOG.md.tmp; then
            mv CHANGELOG.md.tmp CHANGELOG.md
            git add CHANGELOG.md 2>/dev/null
        else
            rm CHANGELOG.md.tmp
        fi
    fi
fi

exit 0
