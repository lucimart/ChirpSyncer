services:
  chirp-syncer:
    build: .
    container_name: chirp-syncer
    environment:
      PYTHONPATH: "/app"
      TWITTER_API_KEY: "${TWITTER_API_KEY}"
      TWITTER_API_SECRET: "${TWITTER_API_SECRET}"
      TWITTER_ACCESS_TOKEN: "${TWITTER_ACCESS_TOKEN}"
      TWITTER_ACCESS_SECRET: "${TWITTER_ACCESS_SECRET}"
      BSKY_USERNAME: "${BSKY_USERNAME}"
      BSKY_PASSWORD: "${BSKY_PASSWORD}"
      REDIS_HOST: "${REDIS_HOST:-redis}"
      REDIS_PORT: "${REDIS_PORT:-6379}"
      CELERY_BROKER_URL: "${CELERY_BROKER_URL:-redis://redis:6379/0}"
      CELERY_RESULT_BACKEND: "${CELERY_RESULT_BACKEND:-redis://redis:6379/1}"
      # Email notifications (Resend)
      SMTP_ENABLED: "${SMTP_ENABLED:-false}"
      SMTP_HOST: "${SMTP_HOST:-smtp.resend.com}"
      SMTP_PORT: "${SMTP_PORT:-587}"
      SMTP_USER: "${SMTP_USER:-resend}"
      SMTP_PASSWORD: "${SMTP_PASSWORD}"
      SMTP_FROM: "${SMTP_FROM}"
    volumes:
      - ./app:/app
      - ./data.db:/app/data.db
    working_dir: /app
    command: python main.py
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    restart: unless-stopped
    depends_on:
      - redis

  chirp-worker:
    build: .
    container_name: chirp-worker
    environment:
      PYTHONPATH: "/app"
      TWITTER_API_KEY: "${TWITTER_API_KEY}"
      TWITTER_API_SECRET: "${TWITTER_API_SECRET}"
      TWITTER_ACCESS_TOKEN: "${TWITTER_ACCESS_TOKEN}"
      TWITTER_ACCESS_SECRET: "${TWITTER_ACCESS_SECRET}"
      BSKY_USERNAME: "${BSKY_USERNAME}"
      BSKY_PASSWORD: "${BSKY_PASSWORD}"
      REDIS_HOST: "${REDIS_HOST:-redis}"
      REDIS_PORT: "${REDIS_PORT:-6379}"
      CELERY_BROKER_URL: "${CELERY_BROKER_URL:-redis://redis:6379/0}"
      CELERY_RESULT_BACKEND: "${CELERY_RESULT_BACKEND:-redis://redis:6379/1}"
      # Email notifications (Resend)
      SMTP_ENABLED: "${SMTP_ENABLED:-false}"
      SMTP_HOST: "${SMTP_HOST:-smtp.resend.com}"
      SMTP_PORT: "${SMTP_PORT:-587}"
      SMTP_USER: "${SMTP_USER:-resend}"
      SMTP_PASSWORD: "${SMTP_PASSWORD}"
      SMTP_FROM: "${SMTP_FROM}"
    volumes:
      - ./app:/app
      - ./data.db:/app/data.db
    working_dir: /app
    command: celery -A app.core.celery_app.celery_app worker --loglevel=info
    restart: unless-stopped
    depends_on:
      - redis

  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      WATCHTOWER_CLEANUP: "true"
      WATCHTOWER_LABEL_ENABLE: "true"
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: chirp-redis
    ports:
      - "6379:6379"
    restart: unless-stopped

  # Celery Beat - Scheduled tasks (weekly reports)
  chirp-beat:
    build: .
    container_name: chirp-beat
    environment:
      PYTHONPATH: "/app"
      REDIS_HOST: "${REDIS_HOST:-redis}"
      REDIS_PORT: "${REDIS_PORT:-6379}"
      CELERY_BROKER_URL: "${CELERY_BROKER_URL:-redis://redis:6379/0}"
      CELERY_RESULT_BACKEND: "${CELERY_RESULT_BACKEND:-redis://redis:6379/1}"
      SMTP_ENABLED: "${SMTP_ENABLED:-false}"
      SMTP_HOST: "${SMTP_HOST:-smtp.resend.com}"
      SMTP_PORT: "${SMTP_PORT:-587}"
      SMTP_USER: "${SMTP_USER:-resend}"
      SMTP_PASSWORD: "${SMTP_PASSWORD}"
      SMTP_FROM: "${SMTP_FROM}"
    volumes:
      - ./app:/app
      - ./data.db:/app/data.db
    working_dir: /app
    command: celery -A app.core.celery_app.celery_app beat --loglevel=info
    restart: unless-stopped
    depends_on:
      - redis
